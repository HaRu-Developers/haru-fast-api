- name: Docker Hub 로그인
  run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

- name: FastAPI 이미지 빌드 & 푸시
  uses: docker/build-push-action@v5
  with:
    context: .
    file: ./Dockerfile
    push: true
    tags: ${{ secrets.DOCKERHUB_USERNAME }}/haru-fast-api:latest
    cache-from: type=local,src=/tmp/.buildx-cache
    cache-to: type=local,dest=/tmp/.buildx-cache

# compose 파일 EC2 전송
- name: Copy docker-compose.fastapi.yml to EC2
  uses: appleboy/scp-action@v0.1.3
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ${{ secrets.EC2_USER }}
    key: ${{ secrets.EC2_SSH_KEY }}
    source: ./docker-compose.fastapi.yml
    target: /home/ubuntu/my-app/

# 재시작
- name: EC2에 접속해서 fast-api-server 재시작
  uses: appleboy/ssh-action@v0.1.6
  with:
    host: ${{ secrets.EC2_HOST }}
    username: ${{ secrets.EC2_USER }}
    key: ${{ secrets.EC2_SSH_KEY }}
    script: |
      docker network inspect haru-network >/dev/null 2>&1 || docker network create haru-network
      cd /home/ubuntu/my-app
      echo "${{ secrets.ENV_FILE }}" > .env
      DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }} docker compose -f docker-compose.fastapi.yml pull fast-api-server
      DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }} docker compose -f docker-compose.fastapi.yml up -d fast-api-server
